
You said:
a apache/nginx drupal website with jupyter labs/notebook intergration and api back-end injection
Git Expert „ÜçGitHub & GitLab„Üç said:

Thought for 13s
Heck yes‚Äîlet‚Äôs spin up a clean, production-style stack where Nginx fronts Drupal (PHP-FPM), proxies to a FastAPI backend, and also proxies JupyterLab (WebSockets + auth) ‚Äî all dockerized so you can docker compose up -d and get to work. üî®ü§ñüîß

Below is a complete, self-contained baseline you can paste into a repo and run. It includes:

docker-compose.yml (nginx + drupal:10-fpm + postgres + fastapi + jupyterlab)

Nginx vhost with:

/ ‚Üí Drupal

/api/ ‚Üí FastAPI

/lab/ ‚Üí JupyterLab (with WebSocket upgrade)

A minimal Drupal custom module (jupyter_embed) that:

Adds a route /jupyter/embed that renders a simple page embedding JupyterLab (iframe) and calls the backend /api/health to prove the integration

A tiny FastAPI backend with /health and /nbexec (toy example)

A simple Makefile for common ops

Security note (quick): this is a functional baseline. For prod, put Jupyter behind SSO/OIDC (oauth2-proxy/Keycloak), set strong tokens, TLS, proper CORS, and harden Nginx/Drupal.

1) docker-compose.yml
version: "3.9"

services:
  nginx:
    image: nginx:1.27
    container_name: web-nginx
    depends_on:
      - php
      - db
      - api
      - jupyter
    ports:
      - "8080:80"
    volumes:
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      - drupal-code:/var/www/html:ro
      - ./nginx/includes:/etc/nginx/includes:ro
    networks: [webnet]

  php:
    image: drupal:10-fpm
    container_name: web-php
    environment:
      PHP_MEMORY_LIMIT: 512M
    volumes:
      - drupal-code:/var/www/html
      - ./drupal/modules/custom:/var/www/html/modules/custom
      - ./drupal/themes/custom:/var/www/html/themes/custom
      - ./drupal/sites:/var/www/html/sites
    networks: [webnet]

  db:
    image: postgres:16
    container_name: web-db
    environment:
      POSTGRES_DB: drupal
      POSTGRES_USER: drupal
      POSTGRES_PASSWORD: drupal
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks: [webnet]

  api:
    image: python:3.11-slim
    container_name: web-api
    working_dir: /app
    command: bash -lc "pip install fastapi uvicorn pydantic && uvicorn app:app --host 0.0.0.0 --port 8000"
    volumes:
      - ./api:/app
    networks: [webnet]

  jupyter:
    image: jupyter/minimal-notebook:latest
    container_name: web-jupyter
    environment:
      JUPYTER_TOKEN: "changeme-please"
      JUPYTER_ENABLE_LAB: "yes"
      # Allow reverse proxy + iframe by same-site nginx
      JUPYTER_CONFIG_DIR: /home/jovyan/.jupyter
    command: start-notebook.sh --LabApp.allow_origin="*" --LabApp.base_url=/lab/ --LabApp.token=${JUPYTER_TOKEN:-changeme-please}
    volumes:
      - ./notebooks:/home/jovyan/work
    networks: [webnet]

networks:
  webnet:

volumes:
  drupal-code:
  pgdata:
2) Nginx config
nginx/conf.d/default.conf

server {
  listen 80 default_server;
  server_name _;

  # Fastcgi helper include
  include /etc/nginx/includes/drupal_fastcgi_params;

  # --- Drupal root served by php-fpm container over fastcgi ---
  root /var/www/html;
  index index.php index.html;

  # Static files shortcut (served directly if present)
  location / {
    try_files $uri /index.php?$query_string;
  }

  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass web-php:9000;
    fastcgi_read_timeout 180s;
  }

  # --- FastAPI backend ---
  location /api/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://web-api:8000/;
  }

  # --- JupyterLab (with WebSockets) ---
  location /lab/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;

    proxy_pass http://web-jupyter:8888/lab/;
  }
}
nginx/includes/drupal_fastcgi_params (tiny helper)

# Minimal fastcgi params override for Drupal/PHP-FPM
fastcgi_param QUERY_STRING       $query_string;
fastcgi_param REQUEST_METHOD     $request_method;
fastcgi_param CONTENT_TYPE       $content_type;
fastcgi_param CONTENT_LENGTH     $content_length;

fastcgi_param SCRIPT_NAME        $fastcgi_script_name;
fastcgi_param REQUEST_URI        $request_uri;
fastcgi_param DOCUMENT_URI       $document_uri;
fastcgi_param DOCUMENT_ROOT      $document_root;
fastcgi_param SERVER_PROTOCOL    $server_protocol;

fastcgi_param GATEWAY_INTERFACE  CGI/1.1;
fastcgi_param SERVER_SOFTWARE    nginx;

fastcgi_param REMOTE_ADDR        $remote_addr;
fastcgi_param REMOTE_PORT        $remote_port;
fastcgi_param SERVER_ADDR        $server_addr;
fastcgi_param SERVER_PORT        $server_port;
fastcgi_param SERVER_NAME        $server_name;

fastcgi_param HTTPS              $https if_not_empty;

# Fix PATH_INFO if needed by contrib modules
fastcgi_param PATH_INFO          "";
3) FastAPI backend
api/app.py

from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI(title="Drupal-API Bridge")

class NbExecReq(BaseModel):
    code: str

@app.get("/health")
def health():
    return {"status": "ok"}

@app.post("/nbexec")
def nbexec(req: NbExecReq):
    # Toy example: do not execute arbitrary code in prod
    # Replace with a safe kernel gateway or pre-defined notebooks.
    # Here we just "echo back" for demo purposes.
    return {"echo": req.code[:200], "note": "Replace with kernel gateway or job queue in production."}
4) Drupal custom module: jupyter_embed
Directory layout (under your repo):

drupal/
‚îî‚îÄ modules/
   ‚îî‚îÄ custom/
      ‚îî‚îÄ jupyter_embed/
         ‚îú‚îÄ jupyter_embed.info.yml
         ‚îú‚îÄ jupyter_embed.routing.yml
         ‚îî‚îÄ src/Controller/JupyterEmbedController.php
drupal/modules/custom/jupyter_embed/jupyter_embed.info.yml

name: Jupyter Embed
type: module
description: "Embed JupyterLab and talk to backend API."
core_version_requirement: ^10
package: Custom
drupal/modules/custom/jupyter_embed/jupyter_embed.routing.yml

jupyter_embed.embed:
  path: '/jupyter/embed'
  defaults:
    _controller: '\Drupal\jupyter_embed\Controller\JupyterEmbedController::embed'
    _title: 'JupyterLab Embedded'
  requirements:
    _permission: 'access content'
drupal/modules/custom/jupyter_embed/src/Controller/JupyterEmbedController.php

<?php

namespace Drupal\jupyter_embed\Controller;

use Drupal\Core\Controller\ControllerBase;

class JupyterEmbedController extends ControllerBase {
  public function embed() {
    // Hit backend health endpoint to prove API wiring:
    $apiHost = \Drupal::request()->getSchemeAndHttpHost();
    $healthUrl = $apiHost . '/api/health';

    $health = 'unknown';
    try {
      $client = \Drupal::httpClient();
      $res = $client->get($healthUrl, ['timeout' => 3]);
      if ($res->getStatusCode() === 200) {
        $health = (string) $res->getBody();
      }
    } catch (\Exception $e) {
      $health = 'error: ' . $e->getMessage();
    }

    // Iframe JupyterLab (nginx proxies /lab/ to Jupyter)
    $iframe = '<iframe src="/lab/" style="width:100%;height:80vh;border:1px solid #ccc;"></iframe>';

    $build = [
      '#type' => 'markup',
      '#markup' => '<h2>JupyterLab</h2><p>Backend health: <code>' . htmlspecialchars($health) . '</code></p>' . $iframe,
    ];
    return $build;
  }
}
In Drupal, enable the module: Extend ‚Üí Jupyter Embed (or drush en jupyter_embed -y), then visit /jupyter/embed.

5) Makefile (optional but handy)
Makefile

DC=docker compose

up:
	$(DC) up -d

down:
	$(DC) down

logs:
	$(DC) logs -f --tail=200

reset:
	$(DC) down -v

sh-nginx:
	$(DC) exec nginx bash

sh-php:
	$(DC) exec php bash

sh-api:
	$(DC) exec api bash

sh-jupyter:
	$(DC) exec jupyter bash
6) First run
docker compose up -d
# Wait a few seconds for Drupal/PHP-FPM & Postgres to initialize.

# Open http://localhost:8080  (Drupal install wizard ‚Üí point to db: host "web-db", user "drupal", pass "drupal", db "drupal")
# Then go to http://localhost:8080/jupyter/embed  (Drupal page with embedded JupyterLab + API health)
# API directly: http://localhost:8080/api/health
# JupyterLab directly: http://localhost:8080/lab/   (token = changeme-please)
Where to paste your notebooks? ‚Üí ./notebooks/ (mounted into Jupyter at /home/jovyan/work)

Hardening & ‚Äúnext big deal‚Äù ideas
SSO/OIDC: put Jupyter behind oauth2-proxy (Nginx ‚Üí oauth2-proxy ‚Üí Jupyter), map to your IdP (Okta/Keycloak/etc.).

Kernel safety: never execute arbitrary code; prefer a kernel gateway or job runner with a queue.

TLS: add listen 443 ssl; + certs or run behind a TLS terminator / cloud LB.

CORS/CSP: tighten headers; only allow your host origins.

Drupal cache: enable OPcache, page caching, reverse proxy cache.

If you want, I can now add OIDC auth in front of Jupyter and the API, or wire up a tag-aware changelog in your repo template. Just say the word. ‚úîÔ∏è
